<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¼ æ ‡æŒ‰é”®æ–­è§¦æ£€æµ‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            padding: 20px;
            color: white;
        }
        
        .container {
            width: 90%;
            max-width: 1000px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 2.2rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .description {
            text-align: center;
            margin-bottom: 25px;
            line-height: 1.6;
            font-size: 1.1rem;
        }
        
        .canvas-container {
            width: 100%;
            height: 200px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        #graphCanvas {
            width: 100%;
            height: 100%;
            background: #0d1b2a;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .stat-box {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
            min-width: 150px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #4cc9f0;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            background: #4361ee;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: #3a56d4;
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        #resetBtn {
            background: #f72585;
        }
        
        #resetBtn:hover {
            background: #e91c7d;
        }
        
        .events {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .events h3 {
            margin-bottom: 10px;
            text-align: center;
        }
        
        #eventsList {
            list-style-type: none;
        }
        
        #eventsList li {
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
        }
        
        .timestamp {
            color: #90e0ef;
        }
        
        .status {
            font-weight: bold;
        }
        
        .status.connected {
            color: #4ade80;
        }
        
        .status.disconnected {
            color: #f87171;
        }
        
        .instructions {
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            font-size: 0.9rem;
        }
        
        .instructions h3 {
            margin-bottom: 10px;
            text-align: center;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        @media (max-width: 768px) {
            .stats {
                flex-direction: column;
                align-items: center;
            }
            
            .stat-box {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ­ é¼ æ ‡æŒ‰é”®æ–­è§¦æ£€æµ‹å·¥å…·</h1>
        
        <p class="description">
            æ£€æµ‹é¼ æ ‡æŒ‰é”®çš„æ–­è§¦æƒ…å†µã€‚æŒ‰ä¸‹é¼ æ ‡æŒ‰é’®å¼€å§‹æ£€æµ‹ï¼Œæ¾å¼€è¶…è¿‡1ç§’ååœæ­¢æ£€æµ‹ã€‚
        </p>
        
        <div class="canvas-container">
            <canvas id="graphCanvas"></canvas>
        </div>
        
        <div class="stats">
            <div class="stat-box">
                <div>å½“å‰çŠ¶æ€</div>
                <div id="currentStatus" class="stat-value">ç­‰å¾…ä¸­</div>
            </div>
            <div class="stat-box">
                <div>æ–­è§¦æ¬¡æ•°</div>
                <div id="disconnectCount" class="stat-value">0</div>
            </div>
            <div class="stat-box">
                <div>æ£€æµ‹æ—¶é—´</div>
                <div id="detectionTime" class="stat-value">0.0s</div>
            </div>
        </div>
        
        <div class="controls">
            <button id="startBtn">å¼€å§‹æ£€æµ‹</button>
            <button id="resetBtn">é‡ç½®æ•°æ®</button>
        </div>
        
        <div class="events">
            <h3>æ–­è§¦äº‹ä»¶è®°å½•</h3>
            <ul id="eventsList"></ul>
        </div>
        
        <div class="instructions">
            <h3>ä½¿ç”¨è¯´æ˜</h3>
            <ul>
                <li>æŒ‰ä¸‹é¼ æ ‡æŒ‰é’®å¼€å§‹æ£€æµ‹ï¼Œæ¾å¼€æŒ‰é’®è¶…è¿‡1ç§’ååœæ­¢æ£€æµ‹</li>
                <li>ç»¿è‰²åŒºåŸŸè¡¨ç¤ºæŒ‰é”®æ­£å¸¸ï¼Œçº¢è‰²åŒºåŸŸè¡¨ç¤ºæ£€æµ‹åˆ°æ–­è§¦</li>
                <li>æ–­è§¦äº‹ä»¶ä¼šè¢«è®°å½•åœ¨ä¸‹æ–¹åˆ—è¡¨ä¸­</li>
                <li>ç‚¹å‡»"å¼€å§‹æ£€æµ‹"æŒ‰é’®å¯ä»¥æ‰‹åŠ¨å¯åŠ¨æ£€æµ‹</li>
                <li>ç‚¹å‡»"é‡ç½®æ•°æ®"æŒ‰é’®å¯ä»¥æ¸…é™¤æ‰€æœ‰è®°å½•</li>
            </ul>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const canvas = document.getElementById('graphCanvas');
            const ctx = canvas.getContext('2d');
            const startBtn = document.getElementById('startBtn');
            const resetBtn = document.getElementById('resetBtn');
            const currentStatus = document.getElementById('currentStatus');
            const disconnectCount = document.getElementById('disconnectCount');
            const detectionTime = document.getElementById('detectionTime');
            const eventsList = document.getElementById('eventsList');
            
            // è®¾ç½®Canvaså°ºå¯¸
            function resizeCanvas() {
                canvas.width = canvas.parentElement.clientWidth;
                canvas.height = canvas.parentElement.clientHeight;
            }
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // çŠ¶æ€å˜é‡
            let isDetecting = false;
            let isMouseDown = false;
            let startTime = 0;
            let lastEventTime = -1;
            let disconnectEvents = [];
            let dataPoints = [];
            let animationId = null;
            let timeoutId = null;
            // æ–°å¢ï¼šå®æ—¶é‡‡æ ·æ•°æ®ç‚¹
            let sampleIntervalId = null;
            const SAMPLE_INTERVAL = 20; // ms
            
            // åˆå§‹åŒ–
            resetData();
            drawGraph();
            
            // äº‹ä»¶ç›‘å¬
            startBtn.addEventListener('click', startDetection);
            resetBtn.addEventListener('click', resetData);
            
            document.addEventListener('mousedown', function(e) {
                if (!isDetecting) {
                    startDetection();
                }
                handleMouseDown(e);
            });
            
            document.addEventListener('mouseup', handleMouseUp);
            
            function startDetection() {
                if (isDetecting) return;

                isDetecting = true;
                startTime = Date.now();
                lastEventTime = -1;
                currentStatus.textContent = "æ£€æµ‹ä¸­";
                startBtn.textContent = "æ£€æµ‹ä¸­...";
                startBtn.disabled = true;

                // æ·»åŠ åˆå§‹æ•°æ®ç‚¹
                dataPoints = [];
                dataPoints.push({ time: 0, value: 1 });

                // å¼€å§‹åŠ¨ç”»
                if (animationId) cancelAnimationFrame(animationId);
                animationId = requestAnimationFrame(updateGraph);

                // å®æ—¶é‡‡æ ·
                if (sampleIntervalId) clearInterval(sampleIntervalId);
                sampleIntervalId = setInterval(samplePoint, SAMPLE_INTERVAL);
            }

            function stopDetection() {
                isDetecting = false;
                isMouseDown = false;
                currentStatus.textContent = "ç­‰å¾…ä¸­";
                startBtn.textContent = "å¼€å§‹æ£€æµ‹";
                startBtn.disabled = false;

                if (timeoutId) clearTimeout(timeoutId);
                if (animationId) cancelAnimationFrame(animationId);

                // åœæ­¢å®æ—¶é‡‡æ ·
                if (sampleIntervalId) clearInterval(sampleIntervalId);
                sampleIntervalId = null;

                // ç»˜åˆ¶æœ€ç»ˆçŠ¶æ€
                drawGraph();
            }
            
            function resetData() {
                // åœæ­¢å½“å‰æ£€æµ‹
                stopDetection();
                
                // é‡ç½®æ‰€æœ‰æ•°æ®
                isDetecting = false;
                isMouseDown = false;
                startTime = 0;
                lastEventTime = -1;
                disconnectEvents = [];
                dataPoints = [];
                
                // é‡ç½®UI
                currentStatus.textContent = "ç­‰å¾…ä¸­";
                disconnectCount.textContent = "0";
                detectionTime.textContent = "0.0s";
                eventsList.innerHTML = "";
                
                // é‡ç»˜å›¾è¡¨
                drawGraph();
            }
            
            // æ–°å¢ï¼šå®æ—¶é‡‡æ ·å‡½æ•°
            function samplePoint() {
                if (!isDetecting || !startTime) return;
                const now = Date.now();
                const elapsedTime = (now - startTime) / 1000;
                const value = isMouseDown ? 1 : 0;
                // åªåœ¨çŠ¶æ€å˜åŒ–æˆ–è¶…è¿‡é‡‡æ ·é—´éš”æ—¶æ·»åŠ æ–°ç‚¹
                if (
                    dataPoints.length === 0 ||
                    dataPoints[dataPoints.length - 1].value !== value ||
                    elapsedTime - dataPoints[dataPoints.length - 1].time > SAMPLE_INTERVAL / 1000
                ) {
                    dataPoints.push({ time: elapsedTime, value });
                }
            }
            
            function handleMouseDown(e) {
                if (!isDetecting) return;
                
                const currentTime = Date.now();
                const elapsedTime = (currentTime - startTime) / 1000;
                
                isMouseDown = true;
                
                // æ£€æŸ¥æ˜¯å¦æ–­è§¦ï¼ˆè·ç¦»ä¸Šæ¬¡äº‹ä»¶è¶…è¿‡50msï¼‰
                if (lastEventTime > 0 ) {
                    // è®°å½•æ–­è§¦äº‹ä»¶
                    disconnectEvents.push({
    start: (lastEventTime - startTime) / 1000,
    end: elapsedTime,
    duration: (currentTime - lastEventTime) / 1000
});
                    
                    // æ›´æ–°UI
                    disconnectCount.textContent = disconnectEvents.length;
                    
                    // æ·»åŠ äº‹ä»¶åˆ°åˆ—è¡¨
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span class="timestamp">${elapsedTime.toFixed(2)}s</span>
                        <span class="status disconnected">æ–­è§¦ ${(currentTime - lastEventTime).toFixed(0)}ms</span>
                    `;
                    eventsList.appendChild(li);
                    eventsList.scrollTop = eventsList.scrollHeight;
                    
                    // æ·»åŠ æ–­è§¦æ•°æ®ç‚¹
                    dataPoints.push({ time: elapsedTime, value: 0 });
                }
                
                // æ·»åŠ æŒ‰ä¸‹æ•°æ®ç‚¹
                dataPoints.push({ time: elapsedTime, value: 1 });
                
                // lastEventTime = currentTime;
                
                // æ›´æ–°æ£€æµ‹æ—¶é—´
                detectionTime.textContent = elapsedTime.toFixed(1) + 's';
                
                // æ¸…é™¤è¶…æ—¶
                if (timeoutId) clearTimeout(timeoutId);
            }
            
            function handleMouseUp() {
                if (!isDetecting || !isMouseDown) return;
                
                isMouseDown = false;
                const currentTime = Date.now();
                const elapsedTime = (currentTime - startTime) / 1000;
                
                // æ·»åŠ é‡Šæ”¾æ•°æ®ç‚¹
                dataPoints.push({ time: elapsedTime, value: 0 });
                
                // è®¾ç½®è¶…æ—¶åœæ­¢æ£€æµ‹ï¼ˆ1ç§’åï¼‰
                if (timeoutId) clearTimeout(timeoutId);
                timeoutId = setTimeout(stopDetection, 1000);
                lastEventTime = currentTime;
            }
            
            function drawGraph() {
    const width = canvas.width;
    const height = canvas.height;
    const WINDOW = 10; // æ˜¾ç¤ºæœ€è¿‘10ç§’

    ctx.clearRect(0, 0, width, height);

    // èƒŒæ™¯ç½‘æ ¼
    ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
    ctx.lineWidth = 1;
    for (let y = 0; y <= height; y += height / 4) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(width, y);
        ctx.stroke();
    }
    for (let x = 0; x <= width; x += width / 10) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, height);
        ctx.stroke();
    }

    // æ²¡æœ‰æ•°æ®æ—¶æç¤º
    if (dataPoints.length === 0) {
        ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('æŒ‰ä¸‹é¼ æ ‡æŒ‰é’®å¼€å§‹æ£€æµ‹', width / 2, height / 2);
        return;
    }

    // è®¡ç®—å½“å‰æ—¶é—´
    const lastTime = dataPoints[dataPoints.length - 1].time;
    // å³ä¾§æ°¸è¿œæ˜¯å½“å‰æ—¶åˆ»ï¼Œæ¨ªåæ ‡ä¸ºç›¸å¯¹æ—¶é—´
    const tEnd = lastTime;
    const tStart = Math.max(0, tEnd - WINDOW);

    // 0æ”¾åœ¨ä¸­é—´
    const centerX = width / 2;
    const tZero = tEnd;
    const tLeft = tZero - WINDOW / 2;
    const tRight = tZero + WINDOW / 2;

    // è¿‡æ»¤çª—å£å†…çš„æ•°æ®
    let points = dataPoints.filter(pt => pt.time >= tLeft - 0.1 && pt.time <= tRight + 0.1);
    // è¡¥é¦–ç‚¹
    if (points.length === 0 || points[0].time > tLeft) {
        // æ‰¾åˆ°å‰ä¸€ä¸ªçŠ¶æ€
        let prev = 0;
        for (let i = dataPoints.length - 1; i >= 0; i--) {
            if (dataPoints[i].time < tLeft) {
                prev = dataPoints[i].value;
                break;
            }
        }
        points.unshift({ time: tLeft, value: prev });
    }

    // é˜¶æ¢¯æ³¢å½¢
    ctx.beginPath();
    ctx.lineWidth = 2;
    let first = true;
    for (let i = 0; i < points.length; i++) {
        const pt = points[i];
        // 0åœ¨ä¸­é—´ï¼Œxè½´æ˜ å°„
        const x = centerX + ((pt.time - tZero) / (WINDOW / 2)) * centerX;
        const y = height - (pt.value * (height / 2) + height / 4);
        if (first) {
            ctx.moveTo(x, y);
            first = false;
        } else {
            const prev = points[i - 1];
            const prevX = centerX + ((prev.time - tZero) / (WINDOW / 2)) * centerX;
            const prevY = height - (prev.value * (height / 2) + height / 4);
            ctx.lineTo(x, prevY);
            ctx.lineTo(x, y);
        }
    }
    ctx.strokeStyle = '#4cc9f0';
    ctx.stroke();

    // å¡«å……åŒºåŸŸï¼ˆé˜´å½±åªåˆ°å½“å‰æ—¶åˆ»ï¼Œä¸è¶…è¿‡å³ä¾§ï¼‰
    ctx.beginPath();
    first = true;
    let shadowEndX = null;
    const nowTime = lastTime; // å½“å‰å®é™…æ—¶é—´
    for (let i = 0; i < points.length; i++) {
        const pt = points[i];
        // åªå¡«å……åˆ°å½“å‰æ—¶é—´ï¼ˆä¸­å¿ƒçº¿ï¼‰
        if (pt.time > nowTime) {
            shadowEndX = centerX;
            const prev = points[i - 1] || points[0];
            const prevY = height - (prev.value * (height / 2) + height / 4);
            ctx.lineTo(shadowEndX, prevY);
            ctx.lineTo(shadowEndX, height);
            break;
        }
        const x = centerX + ((pt.time - tZero) / (WINDOW / 2)) * centerX;
        const y = height - (pt.value * (height / 2) + height / 4);
        if (first) {
            ctx.moveTo(x, y);
            first = false;
        } else {
            const prev = points[i - 1];
            const prevX = centerX + ((prev.time - tZero) / (WINDOW / 2)) * centerX;
            const prevY = height - (prev.value * (height / 2) + height / 4);
            ctx.lineTo(x, prevY);
            ctx.lineTo(x, y);
        }
    }
    if (shadowEndX === null) {
        // å…¨éƒ¨ç‚¹éƒ½åœ¨å½“å‰æ—¶é—´ä¹‹å‰
        ctx.lineTo(centerX, height);
        ctx.lineTo(0, height);
    } else {
        ctx.lineTo(0, height);
    }
    ctx.closePath();
    const gradient = ctx.createLinearGradient(0, 0, 0, height);
    gradient.addColorStop(0, 'rgba(76, 201, 240, 0.3)');
    gradient.addColorStop(1, 'rgba(76, 201, 240, 0.1)');
    ctx.fillStyle = gradient;
    ctx.fill();

    // æ—¶é—´åˆ»åº¦ï¼ˆç›¸å¯¹æ—¶é—´ï¼Œ0åœ¨ä¸­é—´ï¼Œå·¦ä¾§ä¸ºè´Ÿï¼Œå³ä¾§ä¸ºæ­£ï¼‰
    ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
    ctx.font = '12px Arial';
    ctx.textAlign = 'center';
    for (let i = 0; i <= 10; i++) {
        const relT = -WINDOW / 2 + (i / 10) * WINDOW;
        const x = (i / 10) * width;
        ctx.fillText(relT.toFixed(1) + 's', x, height - 5);
        ctx.beginPath();
        ctx.moveTo(x, height - 20);
        ctx.lineTo(x, height - 15);
        ctx.stroke();
    }
    // çŠ¶æ€æ ‡è®°
    ctx.textAlign = 'left';
    ctx.fillText('æŒ‰ä¸‹ (1)', 10, 20);
    ctx.fillText('é‡Šæ”¾ (0)', 10, height - 20);
}
            
            function updateGraph() {
                drawGraph();
                
                if (isDetecting) {
                    animationId = requestAnimationFrame(updateGraph);
                    
                    // æ›´æ–°æ£€æµ‹æ—¶é—´
                    if (startTime > 0) {
                        const elapsedTime = (Date.now() - startTime) / 1000;
                        detectionTime.textContent = elapsedTime.toFixed(1) + 's';
                    }
                }
            }
        });
    </script>
</body>
</html>